generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      Role     @default(PESERTA_MAGANG)
  isActive  Boolean  @default(true)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relasi dengan PesertaMagang
  pesertaMagang PesertaMagang?
  
  // Relasi dengan Pembimbing
  pembimbing    Pembimbing?

  // Relasi dengan ActivityLog
  activityLogs  ActivityLog[]

  @@map("users")
}

model PesertaMagang {
  id             String          @id @default(cuid())
  nama           String
  username       String          @unique
  id_peserta_magang String?      @unique // NISN/NIM
  divisi         String
  instansi       String
  id_instansi    String?
  nomorHp        String
  tanggalMulai   String
  tanggalSelesai String
  namaMentor     String?
  status         StatusPeserta   @default(AKTIF)
  avatar         String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // Relasi dengan User
  userId         String?         @unique
  user           User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relasi dengan Absensi, PengajuanIzin, dan Logbook
  absensi        Absensi[]
  pengajuanIzin  PengajuanIzin[]
  logbook        Logbook[]

  // Relasi dengan Pembimbing
  pembimbingId   String?
  pembimbing     Pembimbing?     @relation(fields: [pembimbingId], references: [id])

  @@map("peserta_magang")
}

model Pembimbing {
  id        String   @id @default(cuid())
  nip       String?  @unique // Optional if not all mentors have NIP immediately, but implementation plan said 'identifier unik tambahan'
  nama      String
  bidang    String
  kuota     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relasi dengan User (Login info)
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relasi dengan Peserta
  peserta   PesertaMagang[]

  @@map("pembimbing")
}

model Absensi {
  id              String        @id @default(cuid())
  pesertaMagangId String
  tipe            TipeAbsensi
  timestamp       String
  lokasi          Json?
  selfieUrl       String?
  qrCodeData      String?
  status          StatusAbsensi @default(VALID)
  catatan         String?
  ipAddress       String?
  device          String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  pesertaMagang   PesertaMagang @relation(fields: [pesertaMagangId], references: [id], onDelete: Cascade)

  @@map("absensi")
}

model PengajuanIzin {
  id               String          @id @default(cuid())
  pesertaMagangId  String
  tipe             TipeIzin
  tanggalMulai     String
  tanggalSelesai   String
  alasan           String
  status           StatusPengajuan @default(PENDING)
  dokumenPendukung String?
  disetujuiOleh    String?
  disetujuiPada    String?
  catatan          String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  pesertaMagang    PesertaMagang   @relation(fields: [pesertaMagangId], references: [id], onDelete: Cascade)

  @@map("pengajuan_izin")
}

model Logbook {
  id              String           @id @default(cuid())
  pesertaMagangId String
  tanggal         String
  kegiatan        String
  deskripsi       String
  durasi          String?
  type            ActivityType?    @default(OTHER)
  status          ActivityStatus?  @default(PENDING)
  fotoKegiatan    String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  pesertaMagang   PesertaMagang    @relation(fields: [pesertaMagangId], references: [id], onDelete: Cascade)

  @@map("logbook")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

enum Role {
  ADMIN
  PESERTA_MAGANG
  PEMBIMBING_MAGANG
}

enum StatusPeserta {
  AKTIF
  NONAKTIF
  SELESAI
}

enum TipeAbsensi {
  MASUK
  KELUAR
  IZIN
  SAKIT
  CUTI
}

enum StatusAbsensi {
  VALID
  INVALID
  TERLAMBAT
}

enum TipeIzin {
  SAKIT
  IZIN
  CUTI
}

enum StatusPengajuan {
  PENDING
  DISETUJUI
  DITOLAK
}

enum ActivityType {
  MEETING
  TRAINING
  PRESENTATION
  DEADLINE
  OTHER
}

enum ActivityStatus {
  COMPLETED
  IN_PROGRESS
  PENDING
  CANCELLED
}

// [NEW] ActivityLog for Event-Driven Timeline
model ActivityLog {
  id          String      @id @default(cuid())
  userId      String      // Actor (Peserta/Pembimbing)
  action      String      // Enum-like: "LOGIN", "LOGBOOK_CREATE", "LOGBOOK_UPDATE", "ABSENSI_IN", "IZIN_REQ"
  entityType  String      // "LOGBOOK", "ABSENSI", "IZIN"
  entityId    String?     // ID of the related record
  description String      // Human readable summary
  metadata    Json?       // Snapshot/Diff data
  createdAt   DateTime    @default(now())

  // Relation
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}
